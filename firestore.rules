
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Funções Auxiliares ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email in [
        "filipe_coval_90@hotmail.com", 
        "mcpoleca@gmail.com", 
        "filipe@teste.com"
      ];
    }

    // --- REGRAS DAS COLEÇÕES (VERSÃO CORRIGIDA E SIMPLIFICADA) ---

    // Regras de acesso público ou apenas para admin
    match /products_inventory/{docId} { allow read, write: if isAdmin(); }
    match /products_public/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /reviews/{docId} { allow get, list, create: if true; allow update, delete: if isAdmin(); }
    match /newsletter_subscriptions/{docId} { allow create: if true; allow read, write, delete: if isAdmin(); }
    match /stock_alerts/{alertId} { allow create: if true; allow read, delete: if isAdmin(); }
    match /online_users/{sessionId} { allow write: if true; allow read: if isAdmin(); }

    // FIX: Adicionada regra para reservas de stock, que estava a causar o crash no checkout
    match /stock_reservations/{docId} {
      // Permite que qualquer pessoa crie, leia e apague reservas.
      // Essencial para o sistema de carrinho de convidados e para a limpeza no checkout.
      // Os dados são temporários e não contêm informação pessoal.
      allow read, write: if true;
    }

    // Regras para Cupões
    match /coupons/{docId} {
      allow get, list: if true;
      allow create: if isAdmin() || (isSignedIn() && request.resource.data.code.matches('REWARD-.*'));
      allow update, delete: if isAdmin();
    }

    // Regras para Utilizadores
    match /users/{userId} {
      allow create: if request.auth.uid == userId || isAdmin();
      allow get, update, delete: if request.auth.uid == userId || isAdmin();
    }

    // --- REGRAS DE ENCOMENDAS (CORREÇÃO DEFINITIVA) ---
    match /orders/{orderId} {
      // Qualquer pessoa pode criar uma encomenda (checkout de convidado)
      allow create: if true;

      // RELEITURA:
      // - Admins podem ler tudo, incondicionalmente.
      // - Um utilizador autenticado pode ler uma encomenda se:
      //   a) O ID da encomenda já lhe pertence.
      //   b) A encomenda ainda não tem dono (userId == null) E o email da encomenda corresponde ao seu.
      //   (A verificação 'resource.data.keys().hasAll' evita erros em documentos antigos)
      allow read: if isAdmin() || (
        isSignedIn() && (
          resource.data.userId == request.auth.uid ||
          (
            resource.data.userId == null &&
            resource.data.keys().hasAll(['shippingInfo']) &&
            resource.data.shippingInfo.keys().hasAll(['email']) &&
            resource.data.shippingInfo.email == request.auth.token.email
          )
        )
      );
      
      // ESCRITA:
      // - Admins podem escrever em tudo.
      // - Um utilizador autenticado pode:
      //   a) Mudar o estado da sua própria encomenda para 'Cancelado'.
      //   b) "Reclamar" uma encomenda de convidado (mudar apenas o userId).
      allow update: if isAdmin() || (
        isSignedIn() && (
          ( // Regra para cancelar
            resource.data.userId == request.auth.uid &&
            request.resource.data.status == 'Cancelado' &&
            resource.data.status in ['Processamento', 'Pago']
          ) ||
          ( // Regra para reclamar encomenda de convidado
            resource.data.userId == null &&
            resource.data.keys().hasAll(['shippingInfo']) &&
            resource.data.shippingInfo.keys().hasAll(['email']) &&
            resource.data.shippingInfo.email == request.auth.token.email &&
            request.resource.data.userId == request.auth.uid &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['userId'])
          )
        )
      );

      // APAGAR: Apenas Admins podem apagar encomendas.
      allow delete: if isAdmin();
    }
  }
}
