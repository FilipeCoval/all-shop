
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Funções Auxiliares ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email in [
        "filipe_coval_90@hotmail.com", 
        "mcpoleca@gmail.com", 
        "filipe@teste.com"
      ];
    }

    // --- REGRAS DAS COLEÇÕES ---

    match /products_inventory/{docId} { allow read, write: if isAdmin(); }
    match /products_public/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /reviews/{docId} { allow get, list, create: if true; allow update, delete: if isAdmin(); }
    match /newsletter_subscriptions/{docId} { allow create: if true; allow read, write, delete: if isAdmin(); }
    match /stock_alerts/{alertId} { allow create: if true; allow read, delete: if isAdmin(); }
    match /online_users/{sessionId} { allow write: if true; allow read: if isAdmin(); }
    match /stock_reservations/{docId} { allow read, write: if true; }

    match /coupons/{docId} {
      allow get, list: if true;
      allow create: if isAdmin() || (isSignedIn() && request.resource.data.code.matches('REWARD-.*'));
      allow update, delete: if isAdmin();
    }

    match /users/{userId} {
      allow create: if (request.auth.uid == userId && request.resource.data.uid == userId) || isAdmin();
      // ALTERAÇÃO: 'read' permite tanto 'get' (individual) como 'list' (todos), essencial para o Dashboard.
      allow read, update, delete: if request.auth.uid == userId || isAdmin();
    }

    match /orders/{orderId} {
      allow create: if true;

      // GET (Ler um doc): Utilizador pode ler a sua própria encomenda.
      allow get: if isAdmin() || (isSignedIn() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.userId == null && resource.data.shippingInfo.email == request.auth.token.email)
      ));
      
      // LIST (Fazer query): Permite que um utilizador procure as suas encomendas ou as que fez como convidado.
      allow list: if isAdmin() || 
                   (isSignedIn() && request.query.where.get('userId')[2] == request.auth.uid) ||
                   (isSignedIn() && request.query.where.get('shippingInfo.email')[2] == request.auth.token.email);

      // UPDATE: Permite a um utilizador cancelar a sua encomenda ou reclamar uma de convidado.
      allow update: if isAdmin() || (isSignedIn() && (
          (
            resource.data.userId == request.auth.uid &&
            request.resource.data.status == 'Cancelado' &&
            resource.data.status in ['Processamento', 'Pago']
          ) ||
          (
            resource.data.userId == null &&
            resource.data.shippingInfo.email == request.auth.token.email &&
            request.resource.data.userId == request.auth.uid &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['userId'])
          )
        )
      );
        
      allow delete: if isAdmin();
    }
  }
}

